#!/usr/bin/env bash

if [ "$#" -lt 2 ]; then
  echo "Usage: $0 ENVIRONMENT IMAGE_TAG" >&2
  exit 1
fi

# exit on any failing command
set -e

environment_name=$1
image_tag=$2
app_version="${image_tag}-`date -u +%s`"
extra_args=${@:3}

# common call
called_file=$0
called_dir=$(realpath `dirname ${called_file}`)
tools_dir=$(dirname `realpath ${called_file}`)
source ${tools_dir}/load_environment_config ${called_dir}

environment_values=`echo "$config" | jq -r ".environments[\"${environment_name}\"].values | map(\"${called_dir}/values/\" + .) | join(\",\")"`

echo $environment_values

if [ "${environment_encryption_key}" != "null" ]
then
  environment_values="${environment_values} --set encryptionKey=${environment_encryption_key}"
fi

helm upgrade \
  ${release} \
  ${called_dir}/chart \
  -n ${environment_namespace} \
  --install \
  --values $environment_values \
  --create-namespace \
  --set image.tag=${image_tag} \
  --set appVersion=${app_version} \
  ${extra_args}

if [ "$extra_args"  == '' ]; then
  ${tools_dir}/track_helm_deployment ${release} ${environment_namespace}
fi
